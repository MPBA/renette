{% extends 'base.html' %}
{% load static %}
{% block extrahead %}
    <link href="{% static "datatables/css/dt_bootstrap.css" %}" rel="stylesheet">
{#    <style>#}
{#        table { table-layout: fixed; }#}
{#        table th, table td { overflow: hidden; }#}
{#    </style>#}
    <script src={% static 'datatables/js/jquery.dataTables.js' %}></script>
    <script src={% static 'datatables/js/bootstrap3_dt.js' %}></script>
    <script src={% static 'js/bootstrap-paginator.js' %}></script>

    <script type="text/javascript" charset="utf-8">
    /* Table initialisation */
            $(document).ready(function() {
                $("#tableslist").on('change', function() {
                    var uninitialized = $('#tablesview').filter(function() {
                        return $.fn.DataTable.fnIsDataTable(this);
                    });
                    if(uninitialized.length){
                        var tb = $('#tablesview').DataTable()
                        tb.fnClearTable(true)
                        tb.fnDestroy()
                    }
                    var pk = $("#tableslist option:selected").attr('pk');
                    var firstrow = eval($("#tableslist option:selected").attr('firstrow'));
                        firstrow.shift();
                    var aryJSONColTable=[];
                    for (var i=0; i < firstrow.length; i++ ) {
                      aryJSONColTable.push({
                                    "sTitle": firstrow[i],
                                    "aTargets": [i]
                       });
                    };
                    $('#tablesview').dataTable({
                        "bProcessing": true,
                        "aoColumnDefs": aryJSONColTable,
                        "sScrollX": "200px",
                        "sAjaxSource": '/engine/datatables/' + pk + "/"
                    });
                });

                /* Pagination setup */
                {% if charts_length %}
                var options = {
                    currentPage: 1,
                    totalPages: {{ charts_length }},
                    bootstrapMajorVersion: 3,
                    numberOfPages: 10,
                    size:"normal",
                    onPageClicked: function(e,originalEvent,type,page){
                        var idx = page - 1;
                        $('#chart-img').attr("src",image_list[idx]);
                        $('#chart-desc').html(image_list_desc[idx]);
                    }
                }
                $('#imagespaginator').bootstrapPaginator(options);

                image_list = [];
                image_list_desc = [];
                {% for c in charts %}
                    image_list.push('{{ c.imagestore.url }}')
                    image_list_desc.push('{{ c.filename }}')
                {% endfor %}
                {% endif %}

                //TRIGGER EVENT
                $("#tableslist").trigger("change")
            });
	    </script>
{% endblock %}
{% block googleanalytics %}
{% endblock %}
{% block container %}

{#{% include 'engine/json_preview.html' %}#}

<div class="row row-offcanvas row-offcanvas-right">

    <div class="col-md-12">
          <div class="row">
            <h1>Network inference result</h1>
            <div class="col-6">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                        <p {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</p>
            </div>
            {% endfor %}
            {% endif %}
            </div><!--/span-->
            <!-- Nav tabs -->
            <ul class="nav nav-tabs">
              <li class="active"><a href="#tables" data-toggle="tab">Tables</a></li>
              <li><a href="#netvis" data-toggle="tab">Network visualization</a></li>
              <li><a href="#charts" data-toggle="tab">Charts</a></li>
              <li><a href="#download" data-toggle="tab">Download area</a></li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
              <div class="tab-pane active" id="tables">
                  <div style="padding-top: 10px; padding-bottom: 10px">
                    <select class="form-control" id="tableslist">
                        {% for t in tables %}
                            <option url="{{ t.filestore.url }}" pk="{{ t.pk }}" firstrow={{ t.get_first_row|safe }}>{{ t.filename }}</option>
                        {% endfor %}
                    </select>
                  </div>
                    <table class="table table-striped" id="tablesview">
                      <thead></thead>
                      <tbody></tbody>
                    </table>
              </div>
              <div class="tab-pane" id="netvis">Network</div>
              <div class="tab-pane" id="charts">
                  <div class="panel panel-default" style="margin-top: 10px;">
                     <div class="panel-heading" id="chart-desc">{{ charts.0.filename }}</div>
                     <div class="panel-body">
                        <img id="chart-img" src="{{ charts.0.imagestore.url }}" class="img-thumbnail img-responsive col-md-6 col-md-offset-3">
                     </div>
                     <div class="panel-body">
                         <ul class="pagination pagination-sm" id="imagespaginator"></ul>
                     </div>
                  </div>

              </div>
              <div class="tab-pane" id="download">
                <table class="table table-striped">
                    <thead>
                    <tr>
                      <th><input type="checkbox" value="" id="selectall"></th>
                      <th>File name</th>
                      <th>File type</th>
                      <th>Size</th>
                      <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <form role="form" method="POST" action="{% url 'process_download_zip' %}">
                    {% csrf_token %}
                    {% for t in tables %}
                    <tr>
                      <td><input type="checkbox" name="files" value="{{ t.pk }}"></td>
                      <td>{{ t.filename }}</td>
                      <td>{{ t.filetype }}</td>
                      <td>{{ t.filestore.size|filesizeformat }}</td>
                      <td><a href="{{ t.filestore.url }}" target="_blank" class="btn btn-primary" role="button">Download</a></td>
                    </tr>
                    {% endfor %}
                    {% for c in charts %}
                    <tr>
                      <td><input type="checkbox" name="files" value="{{ c.pk }}"></td>
                      <td>{{ c.filename }}</td>
                      <td>{{ c.filetype }}</td>
                      <td>{{ c.imagestore.size|filesizeformat }}</td>
                      <td><a href="{{ c.imagestore.url }}" download="{{ c.filename }}" target="_blank" class="btn btn-primary" role="button">Download</a></td>
                    </tr>
                    {% endfor %}
                    {% for g in graphs %}
                    <tr>
                      <td><input type="checkbox" name="files" value="{{ g.pk }}"></td>
                      <td>{{ g.filename }}</td>
                      <td>{{ g.filetype }}</td>
                      <td>{{ g.filestore.size|filesizeformat }}</td>
                      <td><a href="{{ g.filestore.url }}" target="_blank" class="btn btn-primary" role="button">Download</a></td>
                    </tr>
                    {% endfor %}
                    <tr><td colspan="5">
                        <button type="submit" class="btn btn-primary btn-lg btn-block">Download files</button>
                    </td></tr>
                    </form>
                    </tbody>
                </table>
              </div>
            </div>

          </div><!--/row-->
    </div><!--/span-->
</div><!--/row-->
{% endblock container %}



